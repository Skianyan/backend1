<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Negocios DENUE</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* Estilo para que el mapa ocupe toda la ventana visible */
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
        // Coordenadas iniciales
        const LATITUD_CENTRO = 31.866; 
        const LONGITUD_CENTRO = -116.602;
        const ZOOM_INICIAL = 10;
        
        // Nivel de zoom mínimo para iniciar la carga de pines (Opcional, para evitar cargar en vistas muy amplias)
        const ZOOM_MINIMO_CARGA = 16;

        // Inicializar el mapa
        const map = L.map('map').setView([LATITUD_CENTRO, LONGITUD_CENTRO], ZOOM_INICIAL);

        // Añadir capa de mapas
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> | Datos DENUE INEGI',
            maxZoom: 19,
        }).addTo(map);

        // Crear un LayerGroup para manejar solo los pines visibles actualmente
        const visibleMarkers = new L.LayerGroup().addTo(map);

        // Función para cargar los negocios dentro de la vista actual del mapa
        async function cargarNegociosEnVista() {
            
            // Si el zoom está por debajo del mínimo, no cargamos pines para grandes áreas
            if (map.getZoom() < ZOOM_MINIMO_CARGA) {
                visibleMarkers.clearLayers(); // Aseguramos que no haya pines visibles
                //console.log('Zoom insuficiente. Pines ocultos.');
                return;
            }

            // 1. Obtener el Bounding Box (Límites de la vista actual)
            const bounds = map.getBounds();
            const urlParams = new URLSearchParams({
                // Coordenadas SurOeste (min)
                lat_min: bounds.getSouthWest().lat,
                lon_min: bounds.getSouthWest().lng,
                // Coordenadas NorEste (max)
                lat_max: bounds.getNorthEast().lat,
                lon_max: bounds.getNorthEast().lng
            });
            
            // 2. Construir la URL de la API con los parámetros BBOX
            const apiUrl = `/api/datos_negocios?${urlParams.toString()}`;

            try {
                // Realizar la petición al endpoint de Flask
                const response = await fetch(apiUrl);
                const negocios = await response.json();
                
                // 3. Limpiar el mapa antes de dibujar los nuevos pines
                visibleMarkers.clearLayers();
                
                //console.log(`Cargados ${negocios.length} negocios para la vista actual.`);

                // 4. Iterar sobre cada negocio (Asegurar que toda la lógica de pin esté aquí)
                negocios.forEach(negocio => {
                    const lat = negocio.latitud;
                    const lon = negocio.longitud;

                    if (!lat || !lon) {
                        return;
                    }

                    const nombre       = negocio.nom_estab   || 'Sin nombre';
                    const razonSocial  = negocio.raz_social  || '';
                    const localidad    = negocio.localidad   || '';
                    const actividad    = negocio.nombre_act  || '';
                    const tipoAsent    = negocio.tipo_asent  || '';
                    const telefono     = negocio.telefono    || '';
                    const correo       = negocio.correoelec  || '';
                    const webRaw       = negocio.www         || '';
                    const municipio    = negocio.municipio   || '';
                    const codPostal    = negocio.cod_postal  || '';

                    // Normalizar URL
                    let web = webRaw;
                    if (web && !web.toLowerCase().startsWith('http')) {
                        web = 'http://' + web;
                    }

                    const marker = L.marker([lat, lon]);

                    // Construcción del contenido del popup
                    let html = '<div>';

                    // Línea principal: nombre comercial + razón social
                    html += `<b>${nombre}</b>`;
                    if (razonSocial) {
                        html += `<br><small>${razonSocial}</small>`;
                    }
                    html += '<br>';

                    // Localización (tipo de asentamiento + localidad + municipio + CP)
                    const partesLoc = [];
                    if (tipoAsent) partesLoc.push(tipoAsent);
                    if (localidad) partesLoc.push(localidad);
                    if (municipio) partesLoc.push(municipio);
                    if (codPostal) partesLoc.push('CP ' + codPostal);

                    if (partesLoc.length > 0) {
                        html += partesLoc.join(' - ') + '<br>';
                    }

                    // Actividad económica
                    if (actividad) {
                        html += `<em>${actividad}</em><br>`;
                    }

                    // Datos de contacto
                    if (telefono || correo || web) {
                        html += '<hr style="margin:4px 0;">';
                        if (telefono) {
                            html += `Tel: ${telefono}<br>`;
                        }
                        if (correo) {
                            html += `Correo: <a href="mailto:${correo}">${correo}</a><br>`;
                        }
                        if (web) {
                            html += `Web: <a href="${web}" target="_blank" rel="noopener">${webRaw}</a>`;
                        }
                    }

                    html += '</div>';

                    marker.bindPopup(html);
                    visibleMarkers.addLayer(marker);
                });


            } catch (error) {
                console.error('Error al cargar los datos de negocios:', error);
            }
        }

        // Ejecutar la función para la carga inicial
        cargarNegociosEnVista();
        
        // 5. Escuchar el evento 'moveend' (cuando el usuario termina de moverse o hacer zoom)
        map.on('moveend', cargarNegociosEnVista);
    </script>
</body>
</html>